{% extends "layouts/base.html" %}
{% set title = title or 'Подключение Telegram' %}
{% set extra_head %}
<style>
    .tg-session {
        display: grid;
        gap: 24px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        align-items: start;
    }

    .tg-session__qr-box {
        background: #ffffff;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        min-height: 280px;
        justify-content: center;
    }

    .tg-session__qr-img {
        width: 260px;
        height: 260px;
        object-fit: contain;
        display: none;
    }

    .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        background: rgba(59, 130, 246, 0.12);
        color: var(--accent);
    }

    .status-chip.waiting { background: rgba(251, 191, 36, 0.18); color: #b45309; }
    .status-chip.authorized { background: rgba(16, 185, 129, 0.18); color: #047857; }
    .status-chip.needs-2fa { background: rgba(99, 102, 241, 0.18); color: #312e81; }
    .status-chip.offline { background: rgba(220, 38, 38, 0.15); color: var(--danger); }
</style>
{% endset %}

{% block content %}
<section class="surface stack" style="gap: 20px;">
    <div class="stack" style="gap: 8px;">
        <h1 class="section-title">Подключение Telegram</h1>
        <p class="section-subtitle">Отсканируйте QR-код в приложении Telegram. Держите окно открытым до смены статуса на «authorized».</p>
    </div>

    <div class="tg-session">
        <div class="stack" style="gap: 16px;">
            <div class="tg-session__qr-box">
                <img id="tg-qr" class="tg-session__qr-img" alt="QR-код Telegram">
                <div id="tg-qr-fallback" class="muted" style="text-align:center; font-size:0.9rem;">QR генерируется…</div>
            </div>
            <button id="tg-refresh" type="button" class="btn">Обновить QR</button>
            <div id="tg-status" class="status-chip offline">Статус: неизвестен</div>
            <div id="tg-status-message" class="muted" style="font-size:0.9rem;">Пробуем подключиться к Telegram…</div>
        </div>

        <div class="surface surface--muted stack" style="gap: 12px;">
            <h3 style="font-size:1.1rem; margin:0;">Информация</h3>
            <ul class="muted" style="margin:0; padding-left: 18px; line-height:1.6;">
                {% if passport.brand %}<li><strong>Бренд:</strong> {{ passport.brand }}</li>{% endif %}
                {% if passport.agent_name %}<li><strong>Менеджер:</strong> {{ passport.agent_name }}</li>{% endif %}
                {% if passport.city %}<li><strong>Город:</strong> {{ passport.city }}</li>{% endif %}
                <li><strong>Tenant ID:</strong> {{ tenant }}</li>
                <li><strong>API-ключ:</strong> <code class="inline">{{ key }}</code></li>
            </ul>
            {% if persona_preview %}
            <div class="muted" style="font-size:0.9rem;">Персона ассистента:<br><pre class="code" style="white-space: pre-wrap;margin-top:8px;">{{ persona_preview }}</pre></div>
            {% endif %}
            {% if settings_link %}
            <a href="{{ settings_link }}" target="_blank" rel="noopener" class="btn btn--secondary" style="align-self:flex-start;">Открыть настройки</a>
            {% endif %}
        </div>
    </div>

    <div class="surface surface--muted">
        <ul class="muted" style="margin:0; padding-left:18px; line-height:1.6;">
            <li>QR обновляется раз в несколько секунд. При истечении нажмите «Обновить QR».</li>
            <li>Статус <code>waiting_qr</code> означает, что код готов к сканированию. После авторизации статус изменится на <code>authorized</code>.</li>
            <li>Если видите статус <code>needs_2fa</code>, введите пароль в приложении Telegram.</li>
        </ul>
    </div>
</section>
{% endblock %}

{% set extra_scripts %}
<script id="tg-connect-state" type="application/json">{{ {
    "tenant": tenant,
    "key": key,
    "urls": urls,
    "query": query
} | tojson }}</script>
<script src="{{ static_url(request, 'js/connect_tg.js') }}" defer></script>
{% endset %}
