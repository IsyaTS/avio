{% extends "layouts/base.html" %}
{% set title = title or 'Настройки клиента' %}
{% block content %}
<section class="surface stack" data-testid="client-hero">
    <div class="toolbar">
        <div class="stack" style="gap: 10px;">
            <h1 class="section-title">Личный кабинет клиента</h1>
            <p class="section-subtitle">Обновляйте паспорт бренда, голос ассистента и каталоги. Изменения активируются сразу после сохранения.</p>
        </div>
        <div class="hint" style="min-width: 220px;">
            <div style="font-size:0.85rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.08em;">Tenant</div>
            <div style="font-size:1.1rem; font-weight:600;">#{{ tenant }}</div>
            <div style="margin-top:8px; font-size:0.9rem;">Ключ доступа:</div>
            <code class="code-inline" style="margin-top:4px;">{{ key }}</code>
        </div>
    </div>
</section>

<section class="surface stack" data-testid="client-telegram">
    <div class="stack" style="gap:6px;">
        <h2 class="section-title" style="font-size:1.35rem;">Подключение Telegram</h2>
        <p class="section-subtitle">Подключите Telegram через QR-код и управляйте сессией прямо из кабинета.</p>
    </div>
    {% set initial_status = (state.get('status') if state is defined and state else '') or '' %}
    {% set initial_last_error = (state.get('last_error') if state is defined and state else '') or '' %}
    {% set initial_twofa_pending = (state.get('twofa_pending') if state is defined and state else False) or False %}
    {% set initial_needs_twofa = (state.get('needs_2fa') if state is defined and state else False) or False %}
    {% set current_qr_id = (state.get('qr_id') if state is defined and state else '') or '' %}
    {% set initial_twofa_flag = '1' if initial_status == 'needs_2fa' or initial_needs_twofa or initial_twofa_pending else '0' %}
    <div
        class="integration-card stack"
        style="gap:12px;"
        data-tg-initial-status="{{ initial_status|default('', true) }}"
        data-tg-initial-error="{{ initial_last_error|default('', true) }}"
        data-tg-initial-twofa="{{ initial_twofa_flag }}"
        data-tg-initial-twofa-pending="{% if initial_twofa_pending %}1{% else %}0{% endif %}"
        data-tg-initial-qr-id="{{ current_qr_id }}"
        data-tg-poll-interval="2500"
    >
        <div id="tg-integration-status" class="status-text muted">Статус неизвестен</div>
        <div id="tg-qr-block" class="stack" data-qr-id="{{ current_qr_id }}" style="gap:12px; align-items:flex-start;">
            <div class="stack" style="gap:12px; align-items:flex-start;">
                <img
                    id="tg-qr-image"
                    alt="QR-код Telegram"
                    loading="lazy"
                    class="qr-image hidden"
                    style="width:220px; max-width:100%; background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,0.08); padding:12px; box-shadow:0 6px 18px rgba(15,23,42,0.12);"
                    data-cachebuster="{{ '%d' % (qr_timestamp_ms if qr_timestamp_ms is defined else 0) }}"
                >
                <div id="tg-qr-fallback" class="status-text alert hidden"></div>
            </div>
            <div class="stack" style="gap:10px; flex-direction: row; flex-wrap: wrap;">
                <button id="tg-qr-refresh" type="button" class="btn btn--secondary">Обновить QR</button>
                <a id="tg-qr-link" class="btn btn--secondary hidden" role="button" target="_blank" rel="noopener noreferrer" href="#">QR текстом</a>
            </div>
        </div>
        <div id="tg-2fa-block" class="stack hidden" style="gap:12px; max-width:360px;">
            <form id="tg-password-form" class="stack" style="gap:12px;" autocomplete="off" method="post" action="{{ urls.tg_password }}?tenant={{ tenant }}&k={{ key|default('', true)|urlencode }}">
                <label class="grid" style="grid-template-columns: 1fr; gap:6px;">
                    <span class="label">Пароль 2FA</span>
                    <input id="tg-password-input" name="password" type="password" autocomplete="current-password" spellcheck="false" autocapitalize="off" placeholder="Введите пароль" maxlength="128" required>
                </label>
                <div class="stack" style="gap:12px; align-items:flex-start;">
                    <button id="tg-password-submit" type="submit" class="btn">Подтвердить</button>
                    <div id="tg-password-error" class="status-text alert hidden"></div>
                </div>
            </form>
        </div>
        <div class="tg-actions" style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
            <a id="tg-integration-connect" href="{{ urls.tg_start }}?tenant={{ tenant }}&k={{ key|default('', true)|urlencode }}" class="btn" role="button">Подключить Telegram</a>
            <button id="tg-integration-refresh" type="button" class="btn btn--secondary">Обновить статус</button>
            <a id="tg-integration-disconnect" href="{{ urls.tg_logout }}?tenant={{ tenant }}&k={{ key|default('', true)|urlencode }}" class="btn btn--secondary" role="button">Отключить</a>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var card = document.querySelector('.integration-card[data-tg-initial-status]');
            if (!card) {
                return;
            }

            var statusEl = document.getElementById('tg-integration-status');
            var qrBlock = document.getElementById('tg-qr-block');
            var twofaBlock = document.getElementById('tg-2fa-block');
            var qrImage = document.getElementById('tg-qr-image');
            var qrFallback = document.getElementById('tg-qr-fallback');
            var qrLink = document.getElementById('tg-qr-link');
            var passwordInput = document.getElementById('tg-password-input');
            var qrBase = {{ urls.tg_qr_png|tojson }};
            var qrTxtBase = {{ urls.tg_qr_txt|tojson }};

            var rawStatus = (card.dataset.tgInitialStatus || '').trim();
            var status = rawStatus.toLowerCase();
            var lastError = (card.dataset.tgInitialError || '').trim();
            var qrId = (card.dataset.tgInitialQrId || '').trim();
            var needsTwofa = card.dataset.tgInitialTwofa === '1';
            var twofaPending = card.dataset.tgInitialTwofaPending === '1';
            var shouldShowTwofa = status === 'needs_2fa' || needsTwofa || twofaPending;

            function hide(element) {
                if (!element) {
                    return;
                }
                if (!element.classList.contains('hidden')) {
                    element.classList.add('hidden');
                }
            }

            function show(element) {
                if (!element) {
                    return;
                }
                element.classList.remove('hidden');
            }

            function buildUrl(base, params) {
                if (!base) {
                    return null;
                }
                var url;
                try {
                    url = new URL(base, window.location.origin);
                } catch (error) {
                    try {
                        url = new URL(base, window.location.href);
                    } catch (fallbackError) {
                        return null;
                    }
                }
                Object.keys(params || {}).forEach(function (key) {
                    var value = params[key];
                    if (value === undefined || value === null) {
                        return;
                    }
                    url.searchParams.set(key, String(value));
                });
                return url.toString();
            }

            function updateQr(id) {
                if (!id) {
                    if (qrImage) {
                        qrImage.removeAttribute('src');
                        hide(qrImage);
                    }
                    hide(qrLink);
                    return;
                }
                var qrUrl = buildUrl(qrBase, { qr_id: id, t: Date.now() });
                if (qrUrl && qrImage) {
                    qrImage.src = qrUrl;
                    show(qrImage);
                }
                var txtUrl = buildUrl(qrTxtBase, { qr_id: id });
                if (txtUrl && qrLink) {
                    qrLink.href = txtUrl;
                    show(qrLink);
                } else {
                    hide(qrLink);
                }
                if (qrBlock && qrBlock.dataset) {
                    qrBlock.dataset.qrId = id;
                }
                if (qrFallback) {
                    qrFallback.textContent = '';
                }
            }

            function setStatus(message, variant) {
                if (!statusEl) {
                    return;
                }
                var safeVariant = (variant || 'muted').trim();
                statusEl.className = ('status-text ' + safeVariant).trim();
                statusEl.textContent = message || '';
            }

            if (status === 'authorized') {
                setStatus('Подключено', 'success');
                hide(qrBlock);
                hide(twofaBlock);
                return;
            }

            if (shouldShowTwofa) {
                setStatus('Введите пароль двухфакторной аутентификации в Telegram.', 'alert');
                hide(qrBlock);
                show(twofaBlock);
                if (passwordInput) {
                    try {
                        passwordInput.focus();
                    } catch (focusError) {
                        /* ignore */
                    }
                }
                return;
            }

            if (status === 'waiting_qr') {
                setStatus('Сканируйте QR в Telegram → Settings → Devices.', 'warning');
                show(qrBlock);
                hide(twofaBlock);
                updateQr(qrId);
                return;
            }

            if (status === 'disconnected' && (lastError === 'qr_login_timeout' || lastError === 'twofa_timeout')) {
                var message = lastError === 'twofa_timeout'
                    ? 'Время ожидания пароля истекло. Получите новый QR.'
                    : 'QR-код истёк. Получите новый, чтобы продолжить.';
                setStatus(message, 'warning');
                show(qrBlock);
                hide(twofaBlock);
                if (qrId) {
                    updateQr(qrId);
                }
                return;
            }

            if (rawStatus) {
                setStatus('Статус: ' + rawStatus, 'alert');
            } else {
                setStatus('Статус неизвестен', 'muted');
            }
            hide(twofaBlock);
            if (qrId) {
                updateQr(qrId);
            }
        });
    </script>
</section>

<section class="surface stack" data-testid="client-passport">
    <div class="stack" style="gap: 6px;">
        <h2 class="section-title" style="font-size:1.35rem;">Паспорт бренда</h2>
        <p class="section-subtitle">Эти данные используются в промптах, чтобы ассистент звучал как ваша команда.</p>
    </div>
    <form id="settings-form" class="form-grid" autocomplete="off">
        <label>
            <span class="label">Бренд</span>
            <input name="brand" value="{{ form.brand }}" placeholder="Например: Avio">
        </label>
        <label>
            <span class="label">Имя ассистента</span>
            <input name="agent" value="{{ form.agent }}" placeholder="Ирина">
        </label>
        <label>
            <span class="label">Город</span>
            <input name="city" value="{{ form.city }}" placeholder="Москва">
        </label>
        <label>
            <span class="label">Валюта</span>
            <input name="currency" value="{{ form.currency }}" placeholder="₽">
        </label>
        <label class="grid" style="grid-template-columns: 1fr;">
            <span class="label">Тон общения</span>
            <textarea name="tone" rows="3" style="min-height:120px; resize:vertical;">{{ form.tone }}</textarea>
        </label>
        <label>
            <span class="label">CTA (основной)</span>
            <input name="cta_primary" value="{{ form.cta_primary }}" placeholder="Оставить заявку">
        </label>
        <label>
            <span class="label">CTA (fallback)</span>
            <input name="cta_fallback" value="{{ form.cta_fallback }}" placeholder="Получить консультацию">
        </label>
    </form>
    <div style="display:flex; flex-wrap:wrap; gap:12px;">
        <button id="save-settings" type="button">Сохранить паспорт</button>
        <span id="settings-message" class="status-text"></span>
    </div>
</section>

<section class="grid grid--two">
    <div class="surface stack" data-testid="client-persona">
        <div class="stack" style="gap: 6px;">
            <h2 class="section-title" style="font-size:1.35rem;">Персона ассистента</h2>
            <p class="section-subtitle">Опишите стиль общения, запреты и задачи. Чем подробнее, тем точнее ответы.</p>
        </div>
        <textarea id="persona-text">{{ persona }}</textarea>
        <div style="display:flex; flex-wrap:wrap; gap:12px;">
            <button id="save-persona" type="button" class="btn btn--secondary">Сохранить персону</button>
            <button id="download-config" type="button" class="btn btn--secondary">Скачать JSON</button>
            <span id="persona-message" class="status-text"></span>
        </div>
    </div>

    <div class="surface stack" data-testid="client-catalog">
        <div class="stack" style="gap: 6px;">
            <h2 class="section-title" style="font-size:1.35rem;">Каталог товаров</h2>
            <p class="section-subtitle">Загружайте CSV, Excel или PDF. Мы построим индекс и покажем CSV для тонкой настройки.</p>
        </div>
        <form id="upload-form" class="stack" style="gap:12px;" enctype="multipart/form-data">
            <label class="grid" style="grid-template-columns: 1fr;">
                <span class="label">Файл каталога</span>
                <input type="file" name="file" accept=".csv,.xlsx,.xls,.pdf" required>
            </label>
            <div class="progress" id="upload-progress" hidden>
                <div class="progress__bar" id="upload-progress-bar"></div>
            </div>
            <div style="display:flex; gap:12px; flex-wrap:wrap;">
                <button type="submit" class="btn btn--secondary">Загрузить</button>
                {% if form.catalog_file %}
                <span class="badge tag-neutral">Последний файл: {{ form.catalog_file }}</span>
                {% endif %}
            </div>
            <span id="upload-message" class="status-text"></span>
        </form>
        <div class="hint">
            <ul style="margin:0; padding-left: 18px; display:grid; gap: 8px;">
                <li>PDF автоматически индексируется и конвертируется в CSV для правок.</li>
                <li>Максимальный размер файла — 25 МБ. Для больших каталогов используйте ссылки.</li>
                <li>После загрузки бот переключится на свежие данные без перезапуска.</li>
            </ul>
        </div>
    </div>
</section>

<section class="surface stack" data-testid="client-csv-editor">
    <div class="stack" style="gap:6px;">
        <h2 class="section-title" style="font-size:1.35rem;">Редактор каталога</h2>
        <p class="section-subtitle">Правьте данные каталога прямо здесь — изменения сохраняются в CSV.</p>
    </div>
    <div id="csv-toolbar" style="display:flex; gap:12px; flex-wrap:wrap;">
        <button id="csv-refresh" type="button" class="btn btn--secondary">Обновить данные</button>
        <button id="csv-add-row" type="button" class="btn btn--secondary">Добавить строку</button>
        <button id="csv-save" type="button">Сохранить CSV</button>
        <span id="csv-message" class="status-text"></span>
    </div>
    <div id="csv-container" class="surface surface--muted" style="padding: 0; overflow:auto;">
        <div id="csv-empty" class="table-empty">Загрузите PDF или CSV, чтобы редактировать данные каталога.</div>
        <table id="csv-table" class="table" style="display:none;">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
</section>

<section class="surface stack" data-testid="client-dialogs-training">
    <div class="stack" style="gap:6px;">
        <h2 class="section-title" style="font-size:1.35rem;">Диалоги и обучение</h2>
        <p class="section-subtitle">Загрузите собственные примеры или выгрузите недавние переписки из БД.</p>
    </div>

    <div class="grid grid--two" style="gap: 16px; align-items: start;">
        <div class="surface stack" style="gap:12px;">
            <h3 class="section-title" style="font-size:1.1rem;">Загрузка своих диалогов</h3>
            <form id="training-upload-form" class="stack" style="gap:12px;" enctype="multipart/form-data">
                <label class="grid" style="grid-template-columns: 1fr;">
                    <span class="label">Файл (JSONL/JSON/CSV)</span>
                    <input type="file" name="file" accept=".jsonl,.json,.csv" required>
                </label>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <button type="submit" class="btn btn--secondary">Загрузить диалоги</button>
                    <button type="button" id="training-check-status" class="btn btn--secondary">Проверить статус</button>
                </div>
                <div id="training-status" class="status-text"></div>
                <span id="training-upload-message" class="status-text"></span>
            </form>
        </div>

        <div class="surface stack" style="gap:12px;">
            <h3 class="section-title" style="font-size:1.1rem;">Экспорт переписок из БД</h3>
            <div class="status-text">WhatsApp: ZIP с отдельными .txt по диалогу</div>
            <div class="grid" style="grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; align-items: center;">
                <label class="grid" style="grid-template-columns: 1fr;">
                    <span class="label">Дней назад</span>
                    <input id="exp-days" type="number" value="30" min="0" step="1">
                </label>
                <label class="grid" style="grid-template-columns: 1fr;">
                    <span class="label">Количество диалогов</span>
                    <input id="exp-limit" type="number" value="200" min="1" step="1">
                </label>
            </div>
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                <button class="btn" id="export-download" type="button">Скачать архив</button>
                <span id="export-status" class="status-text"></span>
            </div>
        </div>
    </div>
</section>

<script id="client-settings-state" type="application/json">{{ state_payload | tojson }}</script>
<script src="{{ static_url(request, 'js/client-settings.js') }}" defer></script>
{% endblock %}
